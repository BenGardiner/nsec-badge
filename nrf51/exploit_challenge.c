//
//  exploit_challenge.c
//  nsec16
//
//  Created by Marc-Etienne M.Léveillé on 2017-05-06.
//
//

#include "exploit_challenge.h"

#include "ble/nsec_ble.h"
#include <string.h>

const uint8_t vuln_ble_uuid[16] = {
    // 0E5ADACD-62FA-71AA-A046-6168B64BD95E
    0x5E, 0xD9, 0x4B, 0xB6, 0x68, 0x61, 0x46, 0xA0,
    0xAA, 0x71, 0xFA, 0x62, 0xDA, 0xCD, 0x5A, 0x0E
};

enum {
    VULN_CHAR_UUID_SHELLCODE = 0x1337,
};

#ifndef MIN
#define MIN(a,b) (((a)<(b))?(a):(b))
#endif

const char _flag[] __attribute__((used)) = "flag{lslsr0r1#5}";

static nsec_ble_service_handle vuln_ble_handle;
static uint8_t shellcode[64] __attribute__((aligned(2)));

static void nsec_vuln_ble_callback(nsec_ble_service_handle service, uint16_t char_uuid, uint8_t * content, size_t content_length);

void nsec_vuln_init(void) {
    nsec_ble_characteristic_t c[] = {
        {
            .char_uuid = VULN_CHAR_UUID_SHELLCODE,
            .permissions = NSEC_BLE_CHARACT_PERM_RW,
            .max_size = 64,
            .on_write = nsec_vuln_ble_callback,
        },
    };
    nsec_ble_service_t srv = {
        .characteristics_count = sizeof(c) / sizeof(c[0]),
        .characteristics = c,
    };
    memcpy(srv.uuid, vuln_ble_uuid, sizeof(srv.uuid));
    nsec_ble_register_vendor_service(&srv, &vuln_ble_handle);
    nsec_ble_set_charateristic_value(vuln_ble_handle, VULN_CHAR_UUID_SHELLCODE, "", 1);
}

static void nsec_vuln_ble_callback(nsec_ble_service_handle service, uint16_t char_uuid, uint8_t * content, size_t content_length) {
    switch (char_uuid) {
        case VULN_CHAR_UUID_SHELLCODE: {
            memcpy(shellcode, content, MIN(content_length, sizeof(shellcode)));
            ((void (*)(void)) shellcode + 1)();
        }
    }
}
